# 설정 화면 프로필 이미지 업로드 설계

## 목표
- 설정 화면의 프로필 수정 다이얼로그에서 아바타 URL 수동 입력을 제거한다.
- 사용자가 갤러리에서 이미지를 선택하면 앱이 이미지를 업로드하고, 업로드된 URL로 프로필 이미지를 갱신한다.

## 확정된 요구사항
- 이미지 소스: 1차는 `갤러리 선택만` 지원
- 저장 경로: `profile-images/{userId}/avatar.jpg` 고정 경로 덮어쓰기
- 업로드 전 처리: 앱에서 `512x512` 리사이즈 + `JPEG 80%` 압축

## 접근안 비교

### 1) 클라이언트에서 Supabase Storage 직접 업로드 (채택)
- 장점: 구현 단순, 기존 `profile-images` 버킷 정책 재사용 가능
- 단점: 앱에서 업로드 실패/재시도 UX를 직접 처리해야 함

### 2) Edge Function 프록시 업로드
- 장점: 서버에서 검증/가공 일원화
- 단점: 함수 추가/배포/운영 복잡도 증가

### 3) 서명 URL 발급 후 업로드
- 장점: 권한 제어를 더 세밀하게 분리 가능
- 단점: 현재 요구사항 대비 과한 복잡도

## 설계

### UI/UX
- 프로필 수정 다이얼로그에서 `아바타 URL` 입력 필드 제거
- `이미지 선택` 버튼 추가 (Photo Picker 기반)
- 선택된 이미지 미리보기 추가
- 저장 중 상태에서 저장 버튼 비활성화 및 `"저장 중..."` 표시

### 데이터 흐름
1. 사용자가 갤러리에서 이미지를 선택한다.
2. 앱이 선택 이미지를 512x512 JPEG(quality 80) 바이트 배열로 변환한다.
3. `profile-images/{userId}/avatar.jpg`로 업로드(`upsert=true`)한다.
4. 업로드 결과 public URL을 획득한다.
5. 기존 `updateProfile(userId, displayName, avatarUrl)`로 `profiles.avatar_url`를 갱신한다.
6. UI는 최신 프로필 데이터를 다시 로드해 반영한다.

### 권한/보안
- `profile-images` 버킷 정책은 `split_part(name, '/', 1) = auth.uid()`를 요구하므로, object path 첫 세그먼트를 `userId`로 고정한다.
- Photo Picker 사용으로 저장소 권한 요청 부담을 줄인다.

### 예외 처리
- 업로드 실패 시:
  - `updateProfile` 호출하지 않음
  - 에러 스낵바 표시
  - 다이얼로그 유지(재시도 가능)
- 이미지를 선택하지 않은 경우:
  - 기존 avatar URL 유지
  - 닉네임만 수정 가능

### 테스트 전략
- 단위 테스트:
  - 이미지 미선택 시 `updateProfile`만 호출
  - 이미지 선택 시 `upload -> updateProfile` 순서 보장
  - 업로드 실패 시 `updateProfile` 미호출
- 수동 E2E:
  - 이미지 선택 후 저장 즉시 반영
  - 앱 재시작 후 유지 확인
  - 네트워크 실패 시 UX 확인
