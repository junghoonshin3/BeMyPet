name: develop-quality-gate

on:
  pull_request:
    branches:
      - develop
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  develop-quality-gate:
    name: develop-quality-gate
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Prepare CI-only config files
        run: |
          cat > secrets.dev.properties <<'EOF'
          MAPS_API_KEY=dummy-maps-key
          AD_ID=dummy-ad-id
          AD_MOB_BANNER_ID=ca-app-pub-3940256099942544/6300978111
          WEB_CLIENT_ID=dummy-web-client-id
          BASE_URL=https://example.com
          SERVICE_KEY=dummy-service-key
          SUPABASE_URL=https://example.supabase.co
          SUPABASE_ANON_KEY=dummy-supabase-anon-key
          EOF

          cat > secrets.prod.properties <<'EOF'
          MAPS_API_KEY=dummy-maps-key
          AD_ID=dummy-ad-id
          AD_MOB_BANNER_ID=ca-app-pub-3940256099942544/6300978111
          WEB_CLIENT_ID=dummy-web-client-id
          BASE_URL=https://example.com
          SERVICE_KEY=dummy-service-key
          SUPABASE_URL=https://example.supabase.co
          SUPABASE_ANON_KEY=dummy-supabase-anon-key
          STORE_FILE=dummy-release.jks
          KEY_ALIAS=dummy-alias
          KEY_PASSWORD=dummy-password
          STORE_PASSWORD=dummy-password
          EOF

          mkdir -p app/src/debug
          cat > app/src/debug/google-services.json <<'EOF'
          {
            "project_info": {
              "project_number": "123456789012",
              "project_id": "bemypet-ci-debug",
              "storage_bucket": "bemypet-ci-debug.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789012:android:abcdef123456",
                  "android_client_info": {
                    "package_name": "kr.sjh.bemypet.debug"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "dummy-api-key"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF

          mkdir -p app/src
          cat > app/src/google-services.json <<'EOF'
          {
            "project_info": {
              "project_number": "123456789012",
              "project_id": "bemypet-ci-release",
              "storage_bucket": "bemypet-ci-release.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789012:android:abcdef654321",
                  "android_client_info": {
                    "package_name": "kr.sjh.bemypet"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "dummy-api-key"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      - name: Run debug unit tests
        run: ./gradlew :app:testDebugUnitTest --no-daemon
